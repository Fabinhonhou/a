<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Santoro's Italian Restaurant</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">Santoro's Admin</a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">Website</a>
                </li>
                <li class="nav-item">
                    <a href="admin.html" class="nav-link active">Dashboard</a>
                </li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Login</h3>
            </div>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminPassword">Admin Password</label>
                    <input type="password" id="adminPassword" name="adminPassword" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
            </form>
            <div id="admin-login-error" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <p>Invalid admin password</p>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <main class="admin-page" id="adminDashboard" style="display: none;">
        <div class="container">
            <div class="page-header">
                <h1>Admin Dashboard</h1>
                <p>Manage reservations and inventory for Santoro's Restaurant</p>
            </div>

            <!-- Stats Overview -->
            <section class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="todayReservations">0</h3>
                            <p>Today's Reservations</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="pendingReservations">0</h3>
                            <p>Pending Reservations</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalGuests">0</h3>
                            <p>Total Guests Today</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="lowStockItems">0</h3>
                            <p>Low Stock Items</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="reservations">
                    <i class="fas fa-calendar-alt"></i>
                    Reservations
                </button>
                <button class="tab-btn" data-tab="inventory">
                    <i class="fas fa-boxes"></i>
                    Inventory
                </button>
                <button class="tab-btn" data-tab="menu">
                    <i class="fas fa-utensils"></i>
                    Menu Management
                </button>
            </div>

            <!-- Reservations Tab -->
            <section id="reservations-tab" class="tab-content active">
                <div class="section-header">
                    <h2>Reservations Management</h2>
                    <div class="filter-controls">
                        <select id="dateFilter">
                            <option value="today">Today</option>
                            <option value="tomorrow">Tomorrow</option>
                            <option value="week">This Week</option>
                            <option value="all">All</option>
                        </select>
                        <select id="statusFilter">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <div id="reservations-table" class="admin-table-container">
                    <div class="text-center" style="padding: 2rem;">
                        <p>Loading reservations...</p>
                    </div>
                </div>
            </section>

            <!-- Inventory Tab -->
            <section id="inventory-tab" class="tab-content">
                <div class="section-header">
                    <h2>Inventory Management</h2>
                    <button class="btn btn-primary" id="addInventoryBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div id="inventory-table" class="admin-table-container">
                    <div class="text-center" style="padding: 2rem;">
                        <p>Loading inventory...</p>
                    </div>
                </div>
            </section>

            <!-- Menu Management Tab -->
            <section id="menu-tab" class="tab-content">
                <div class="section-header">
                    <h2>Menu Management</h2>
                    <button class="btn btn-primary" id="addMenuItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Menu Item
                    </button>
                </div>
                
                <div id="menu-table" class="admin-table-container">
                    <div class="text-center" style="padding: 2rem;">
                        <p>Loading menu items...</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Add/Edit Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="inventoryModalTitle">Add Inventory Item</h3>
                <span class="close" id="closeInventoryModal">&times;</span>
            </div>
            <form id="inventoryForm">
                <input type="hidden" id="inventoryId">
                <div class="form-group">
                    <label for="itemName">Item Name</label>
                    <input type="text" id="itemName" name="itemName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="vegetables">Vegetables</option>
                            <option value="meat">Meat</option>
                            <option value="seafood">Seafood</option>
                            <option value="dairy">Dairy</option>
                            <option value="grains">Grains</option>
                            <option value="spices">Spices</option>
                            <option value="beverages">Beverages</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="unit">Unit</label>
                        <select id="unit" name="unit" required>
                            <option value="">Select Unit</option>
                            <option value="kg">Kilograms</option>
                            <option value="lbs">Pounds</option>
                            <option value="pieces">Pieces</option>
                            <option value="liters">Liters</option>
                            <option value="bottles">Bottles</option>
                            <option value="boxes">Boxes</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentStock">Current Stock</label>
                        <input type="number" id="currentStock" name="currentStock" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="minStock">Minimum Stock</label>
                        <input type="number" id="minStock" name="minStock" min="0" step="0.1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="supplier">Supplier</label>
                    <input type="text" id="supplier" name="supplier">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" id="cancelInventory">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Menu Item Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="menuModalTitle">Add Menu Item</h3>
                <span class="close" id="closeMenuModal">&times;</span>
            </div>
            <form id="menuForm">
                <input type="hidden" id="menuItemId">
                <div class="form-group">
                    <label for="menuItemName">Item Name</label>
                    <input type="text" id="menuItemName" name="menuItemName" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="menuCategory">Category</label>
                        <select id="menuCategory" name="menuCategory" required>
                            <option value="">Select Category</option>
                            <option value="antipasti">Antipasti</option>
                            <option value="pasta">Pasta</option>
                            <option value="secondi">Secondi Piatti</option>
                            <option value="dolci">Dolci</option>
                            <option value="beverages">Beverages</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="price">Price ($)</label>
                        <input type="number" id="price" name="price" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="imageUrl">Image URL</label>
                    <input type="url" id="imageUrl" name="imageUrl">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="available" name="available" checked>
                    <label for="available">Available</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" id="cancelMenu">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Santoro's Italian Restaurant Admin Panel. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        // Admin JavaScript inline
        let adminToken = null;

        document.addEventListener("DOMContentLoaded", () => {
          console.log("🚀 Admin page loaded")
          
          // Check if admin is already logged in
          const storedToken = localStorage.getItem("adminToken")
          if (storedToken) {
            adminToken = storedToken
            showAdminDashboard()
          } else {
            showAdminLogin()
          }
        })

        function showAdminLogin() {
          console.log("🔐 Redirecting to admin login page")
          window.location.href = "admin-login.html"
        }

        function showAdminDashboard() {
          console.log("📊 Showing admin dashboard")
          document.getElementById("adminDashboard").style.display = "block"
          
          // Update navigation
          if (window.refreshNavigation) {
            window.refreshNavigation()
          }
          
          // Load admin profile
          loadAdminProfile()
          
          // Initialize dashboard
          initializeAdminDashboard()
        }

        // Adicionar nova função para carregar perfil do admin:
        async function loadAdminProfile() {
          try {
            const response = await makeAdminRequest("/api/admin/profile")
            const data = await response.json()

            if (data.success) {
              console.log("✅ Admin profile loaded:", data.admin)
              
              // Salvar dados do admin no localStorage
              localStorage.setItem("adminData", JSON.stringify(data.admin))
              
              // Update navigation with admin name
              const navLogo = document.querySelector(".nav-logo a")
              if (navLogo) {
                navLogo.textContent = `Santoro's Admin - ${data.admin.name}`
              }

              // Update page header
              const pageHeader = document.querySelector(".page-header p")
              if (pageHeader) {
                pageHeader.textContent = `Welcome back, ${data.admin.name}! Manage your restaurant operations.`
              }
            }
          } catch (error) {
            console.error("Failed to load admin profile:", error)
          }
        }

        async function handleAdminLogin(e) {
          e.preventDefault()
          
          const password = document.getElementById("adminPassword").value
          console.log("🔑 Attempting admin login")
          
          try {
            const response = await fetch("/api/admin/login", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ password }),
            })

            const data = await response.json()
            console.log("Login response:", data)

            if (response.ok && data.success) {
              adminToken = data.token
              localStorage.setItem("adminToken", adminToken)
              console.log("✅ Admin login successful")
              showAdminDashboard()
            } else {
              console.log("❌ Admin login failed")
              document.getElementById("admin-login-error").style.display = "block"
            }
          } catch (error) {
            console.error("Admin login error:", error)
            document.getElementById("admin-login-error").style.display = "block"
          }
        }

        function initializeAdminDashboard() {
          console.log("🔧 Initializing admin dashboard")
          
          // Load dashboard data
          loadDashboardStats()
          loadReservations()
          loadInventory()
          loadMenuItems()

          // Setup tab navigation
          setupTabNavigation()

          // Setup event listeners
          setupEventListeners()

          // Setup logout - será gerenciado pelo main.js
          // Remover esta linha: document.getElementById("adminLogoutBtn")?.addEventListener("click", (e) => {
        }

        function adminLogout() {
          console.log("🚪 Admin logout")
          localStorage.removeItem("adminToken")
          localStorage.removeItem("adminData")
          adminToken = null
          window.location.href = "admin-login.html"
        }

        function setupTabNavigation() {
          const tabButtons = document.querySelectorAll(".tab-btn")
          const tabContents = document.querySelectorAll(".tab-content")

          tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const targetTab = button.getAttribute("data-tab")

              // Remove active class from all buttons and contents
              tabButtons.forEach((btn) => btn.classList.remove("active"))
              tabContents.forEach((content) => content.classList.remove("active"))

              // Add active class to clicked button and corresponding content
              button.classList.add("active")
              document.getElementById(`${targetTab}-tab`).classList.add("active")
            })
          })
        }

        function setupEventListeners() {
          // Filter controls
          document.getElementById("dateFilter")?.addEventListener("change", loadReservations)
          document.getElementById("statusFilter")?.addEventListener("change", loadReservations)

          // Modal controls
          setupModalControls()

          // Add buttons
          document.getElementById("addInventoryBtn")?.addEventListener("click", () => openInventoryModal())
          document.getElementById("addMenuItemBtn")?.addEventListener("click", () => openMenuModal())
        }

        function setupModalControls() {
          // Inventory modal
          const inventoryModal = document.getElementById("inventoryModal")
          const closeInventoryModal = document.getElementById("closeInventoryModal")
          const cancelInventory = document.getElementById("cancelInventory")

          closeInventoryModal?.addEventListener("click", () => {
            inventoryModal.style.display = "none"
          })

          cancelInventory?.addEventListener("click", () => {
            inventoryModal.style.display = "none"
          })

          // Menu modal
          const menuModal = document.getElementById("menuModal")
          const closeMenuModal = document.getElementById("closeMenuModal")
          const cancelMenu = document.getElementById("cancelMenu")

          closeMenuModal?.addEventListener("click", () => {
            menuModal.style.display = "none"
          })

          cancelMenu?.addEventListener("click", () => {
            menuModal.style.display = "none"
          })

          // Form submissions
          document.getElementById("inventoryForm")?.addEventListener("submit", handleInventorySubmit)
          document.getElementById("menuForm")?.addEventListener("submit", handleMenuSubmit)

          // Close modals when clicking outside
          window.addEventListener("click", (e) => {
            if (e.target === inventoryModal) {
              inventoryModal.style.display = "none"
            }
            if (e.target === menuModal) {
              menuModal.style.display = "none"
            }
          })
        }

        async function makeAdminRequest(url, options = {}) {
          if (!adminToken) {
            throw new Error("No admin token")
          }

          const headers = {
            "Content-Type": "application/json",
            Authorization: `Bearer ${adminToken}`,
            ...options.headers,
          }

          const response = await fetch(url, {
            ...options,
            headers,
          })

          if (response.status === 401 || response.status === 403) {
            console.log("❌ Admin token expired, redirecting to login")
            adminLogout()
            throw new Error("Authentication failed")
          }

          return response
        }

        async function loadDashboardStats() {
          console.log("📊 Loading dashboard stats")
          try {
            const response = await makeAdminRequest("/api/admin/stats")
            const data = await response.json()

            if (data.success) {
              document.getElementById("todayReservations").textContent = data.stats.todayReservations
              document.getElementById("pendingReservations").textContent = data.stats.pendingReservations
              document.getElementById("totalGuests").textContent = data.stats.totalGuests
              document.getElementById("lowStockItems").textContent = data.stats.lowStockItems
              console.log("✅ Dashboard stats loaded")
            }
          } catch (error) {
            console.error("Failed to load dashboard stats:", error)
          }
        }

        async function loadReservations() {
          console.log("📋 Loading reservations")
          try {
            const dateFilter = document.getElementById("dateFilter")?.value || "today"
            const statusFilter = document.getElementById("statusFilter")?.value || "all"

            const url = `/api/admin/reservations?dateFilter=${dateFilter}&statusFilter=${statusFilter}`
            const response = await makeAdminRequest(url)
            const data = await response.json()

            if (data.success) {
              displayReservations(data.reservations)
              console.log("✅ Reservations loaded:", data.reservations.length)
            }
          } catch (error) {
            console.error("Failed to load reservations:", error)
            displayError("reservations-table", "Failed to load reservations")
          }
        }

        function displayReservations(reservations) {
          const container = document.getElementById("reservations-table")

          if (reservations.length === 0) {
            container.innerHTML = `
              <div class="text-center" style="padding: 2rem;">
                <p>No reservations found for the selected filters.</p>
              </div>
            `
            return
          }

          const tableHTML = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Customer</th>
                  <th>Contact</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Guests</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${reservations
                  .map(
                    (reservation) => `
                    <tr>
                      <td>#${reservation.id}</td>
                      <td>${reservation.name}</td>
                      <td>
                        <div>${reservation.email}</div>
                        <div style="font-size: 0.875rem; color: #666;">${reservation.phone}</div>
                      </td>
                      <td>${formatDate(reservation.date)}</td>
                      <td>${reservation.time}</td>
                      <td>${reservation.guests}</td>
                      <td>
                        <span class="status-badge status-${reservation.status}">
                          ${reservation.status.charAt(0).toUpperCase() + reservation.status.slice(1)}
                        </span>
                      </td>
                      <td>
                        <div class="action-buttons">
                          ${
                            reservation.status === "pending"
                              ? `<button class="btn btn-success btn-sm" onclick="updateReservationStatus('${reservation.id}', 'confirmed')">Confirm</button>`
                              : ""
                          }
                          ${
                            reservation.status !== "cancelled"
                              ? `<button class="btn btn-danger btn-sm" onclick="updateReservationStatus('${reservation.id}', 'cancelled')">Cancel</button>`
                              : ""
                          }
                        </div>
                      </td>
                    </tr>
                  `,
                  )
                  .join("")}
              </tbody>
            </table>
          `

          container.innerHTML = tableHTML
        }

        async function updateReservationStatus(reservationId, status) {
          console.log(`🔄 Updating reservation ${reservationId} to ${status}`)
          
          if (!confirm(`Are you sure you want to ${status} this reservation?`)) {
            return
          }

          try {
            const response = await makeAdminRequest(`/api/admin/reservations/${reservationId}`, {
              method: "PUT",
              body: JSON.stringify({ status }),
            })

            const data = await response.json()

            if (data.success) {
              console.log("✅ Reservation status updated")
              loadReservations()
              loadDashboardStats()
              alert(`Reservation ${status} successfully!`)
            } else {
              throw new Error(data.message)
            }
          } catch (error) {
            console.error("Failed to update reservation:", error)
            alert("Failed to update reservation")
          }
        }

        async function loadInventory() {
          console.log("📦 Loading inventory")
          try {
            const response = await makeAdminRequest("/api/admin/inventory")
            const data = await response.json()

            if (data.success) {
              displayInventory(data.inventory)
              console.log("✅ Inventory loaded:", data.inventory.length)
            }
          } catch (error) {
            console.error("Failed to load inventory:", error)
            displayError("inventory-table", "Failed to load inventory")
          }
        }

        function displayInventory(inventory) {
          const container = document.getElementById("inventory-table")

          if (inventory.length === 0) {
            container.innerHTML = `
              <div class="text-center" style="padding: 2rem;">
                <p>No inventory items found.</p>
              </div>
            `
            return
          }

          const tableHTML = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Item Name</th>
                  <th>Category</th>
                  <th>Current Stock</th>
                  <th>Min Stock</th>
                  <th>Unit</th>
                  <th>Status</th>
                  <th>Supplier</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${inventory
                  .map(
                    (item) => `
                    <tr>
                      <td>${item.name}</td>
                      <td>${item.category}</td>
                      <td>${item.current_stock}</td>
                      <td>${item.min_stock}</td>
                      <td>${item.unit}</td>
                      <td>
                        <span class="stock-status ${getStockStatusClass(item.current_stock, item.min_stock)}">
                          ${getStockStatus(item.current_stock, item.min_stock)}
                        </span>
                      </td>
                      <td>${item.supplier || "-"}</td>
                      <td>
                        <div class="action-buttons">
                          <button class="btn btn-warning btn-sm" onclick="editInventoryItem('${item.id}')">Edit</button>
                          <button class="btn btn-danger btn-sm" onclick="deleteInventoryItem('${item.id}')">Delete</button>
                        </div>
                      </td>
                    </tr>
                  `,
                  )
                  .join("")}
              </tbody>
            </table>
          `

          container.innerHTML = tableHTML
        }

        async function loadMenuItems() {
          console.log("🍝 Loading menu items")
          try {
            const response = await makeAdminRequest("/api/admin/menu")
            const data = await response.json()

            if (data.success) {
              displayMenuItems(data.menuItems)
              console.log("✅ Menu items loaded:", data.menuItems.length)
            }
          } catch (error) {
            console.error("Failed to load menu items:", error)
            displayError("menu-table", "Failed to load menu items")
          }
        }

        function displayMenuItems(menuItems) {
          const container = document.getElementById("menu-table")

          if (menuItems.length === 0) {
            container.innerHTML = `
              <div class="text-center" style="padding: 2rem;">
                <p>No menu items found.</p>
              </div>
            `
            return
          }

          const tableHTML = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Available</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${menuItems
                  .map(
                    (item) => `
                    <tr>
                      <td>
                        <div style="font-weight: 600;">${item.name}</div>
                        <div style="font-size: 0.875rem; color: #666;">${item.description}</div>
                      </td>
                      <td>${item.category}</td>
                      <td>$${item.price}</td>
                      <td>
                        <span class="status-badge ${item.available ? "status-confirmed" : "status-cancelled"}">
                          ${item.available ? "Available" : "Unavailable"}
                        </span>
                      </td>
                      <td>
                        <div class="action-buttons">
                          <button class="btn btn-warning btn-sm" onclick="editMenuItem('${item.id}')">Edit</button>
                          <button class="btn btn-danger btn-sm" onclick="deleteMenuItem('${item.id}')">Delete</button>
                        </div>
                      </td>
                    </tr>
                  `,
                  )
                  .join("")}
              </tbody>
            </table>
          `

          container.innerHTML = tableHTML
        }

        // Modal functions
        function openInventoryModal(item = null) {
          const modal = document.getElementById("inventoryModal")
          const form = document.getElementById("inventoryForm")
          const title = document.getElementById("inventoryModalTitle")

          if (item) {
            title.textContent = "Edit Inventory Item"
            document.getElementById("inventoryId").value = item.id
            document.getElementById("itemName").value = item.name
            document.getElementById("category").value = item.category
            document.getElementById("unit").value = item.unit
            document.getElementById("currentStock").value = item.current_stock
            document.getElementById("minStock").value = item.min_stock
            document.getElementById("supplier").value = item.supplier || ""
          } else {
            title.textContent = "Add Inventory Item"
            form.reset()
            document.getElementById("inventoryId").value = ""
          }

          modal.style.display = "block"
        }

        function openMenuModal(item = null) {
          const modal = document.getElementById("menuModal")
          const form = document.getElementById("menuForm")
          const title = document.getElementById("menuModalTitle")

          if (item) {
            title.textContent = "Edit Menu Item"
            document.getElementById("menuItemId").value = item.id
            document.getElementById("menuItemName").value = item.name
            document.getElementById("description").value = item.description
            document.getElementById("menuCategory").value = item.category
            document.getElementById("price").value = item.price
            document.getElementById("imageUrl").value = item.image_url || ""
            document.getElementById("available").checked = item.available
          } else {
            title.textContent = "Add Menu Item"
            form.reset()
            document.getElementById("menuItemId").value = ""
            document.getElementById("available").checked = true
          }

          modal.style.display = "block"
        }

        // Form handlers
        async function handleInventorySubmit(e) {
          e.preventDefault()

          const formData = new FormData(e.target)
          const inventoryData = {
            name: formData.get("itemName"),
            category: formData.get("category"),
            unit: formData.get("unit"),
            currentStock: parseFloat(formData.get("currentStock")),
            minStock: parseFloat(formData.get("minStock")),
            supplier: formData.get("supplier"),
          }

          const inventoryId = formData.get("inventoryId") || document.getElementById("inventoryId").value

          try {
            let response
            if (inventoryId) {
              response = await makeAdminRequest(`/api/admin/inventory/${inventoryId}`, {
                method: "PUT",
                body: JSON.stringify(inventoryData),
              })
            } else {
              response = await makeAdminRequest("/api/admin/inventory", {
                method: "POST",
                body: JSON.stringify(inventoryData),
              })
            }

            const data = await response.json()

            if (data.success) {
              document.getElementById("inventoryModal").style.display = "none"
              loadInventory()
              loadDashboardStats()
              alert("Inventory item saved successfully!")
            } else {
              throw new Error(data.message)
            }
          } catch (error) {
            console.error("Failed to save inventory item:", error)
            alert("Failed to save inventory item")
          }
        }

        async function handleMenuSubmit(e) {
          e.preventDefault()

          const formData = new FormData(e.target)
          const menuData = {
            name: formData.get("menuItemName"),
            description: formData.get("description"),
            category: formData.get("menuCategory"),
            price: parseFloat(formData.get("price")),
            imageUrl: formData.get("imageUrl"),
            available: formData.get("available") === "on",
          }

          const menuItemId = formData.get("menuItemId") || document.getElementById("menuItemId").value

          try {
            let response
            if (menuItemId) {
              response = await makeAdminRequest(`/api/admin/menu/${menuItemId}`, {
                method: "PUT",
                body: JSON.stringify(menuData),
              })
            } else {
              response = await makeAdminRequest("/api/admin/menu", {
                method: "POST",
                body: JSON.stringify(menuData),
              })
            }

            const data = await response.json()

            if (data.success) {
              document.getElementById("menuModal").style.display = "none"
              loadMenuItems()
              alert("Menu item saved successfully!")
            } else {
              throw new Error(data.message)
            }
          } catch (error) {
            console.error("Failed to save menu item:", error)
            alert("Failed to save menu item")
          }
        }

        // Action functions
        async function editInventoryItem(itemId) {
          try {
            const response = await makeAdminRequest("/api/admin/inventory")
            const data = await response.json()
            
            if (data.success) {
              const item = data.inventory.find(i => i.id == itemId)
              if (item) {
                openInventoryModal(item)
              }
            }
          } catch (error) {
            console.error("Failed to load inventory item:", error)
            alert("Failed to load inventory item")
          }
        }

        async function deleteInventoryItem(itemId) {
          if (!confirm("Are you sure you want to delete this inventory item?")) {
            return
          }

          try {
            const response = await makeAdminRequest(`/api/admin/inventory/${itemId}`, {
              method: "DELETE",
            })

            const data = await response.json()

            if (data.success) {
              loadInventory()
              loadDashboardStats()
              alert("Inventory item deleted successfully!")
            } else {
              throw new Error(data.message)
            }
          } catch (error) {
            console.error("Failed to delete inventory item:", error)
            alert("Failed to delete inventory item")
          }
        }

        async function editMenuItem(itemId) {
          try {
            const response = await makeAdminRequest("/api/admin/menu")
            const data = await response.json()
            
            if (data.success) {
              const item = data.menuItems.find(i => i.id == itemId)
              if (item) {
                openMenuModal(item)
              }
            }
          } catch (error) {
            console.error("Failed to load menu item:", error)
            alert("Failed to load menu item")
          }
        }

        async function deleteMenuItem(itemId) {
          if (!confirm("Are you sure you want to delete this menu item?")) {
            return
          }

          try {
            const response = await makeAdminRequest(`/api/admin/menu/${itemId}`, {
              method: "DELETE",
            })

            const data = await response.json()

            if (data.success) {
              loadMenuItems()
              alert("Menu item deleted successfully!")
            } else {
              throw new Error(data.message)
            }
          } catch (error) {
            console.error("Failed to delete menu item:", error)
            alert("Failed to delete menu item")
          }
        }

        // Utility functions
        function getStockStatus(current, min) {
          if (current === 0) return "Out of Stock"
          if (current <= min) return "Low Stock"
          return "Good"
        }

        function getStockStatusClass(current, min) {
          if (current === 0) return "stock-out"
          if (current <= min) return "stock-low"
          return "stock-good"
        }

        function formatDate(dateString) {
          const date = new Date(dateString)
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          })
        }

        function displayError(containerId, message) {
          const container = document.getElementById(containerId)
          if (container) {
            container.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>${message}</p>
              </div>
            `
          }
        }
    </script>
</body>
</html>
